name: Build

# Run this workflow every time a new commit pushed to your repository

on: push

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  super-lint:
    # Name the Job
    name: Build, test, package and sign release
    # Set the type of machine to run on
    runs-on: windows-latest

    steps:
      - name: Stub Node dependencies
        shell: bash
        run: touch package-lock.json
      - name: Install Node for coverage reporting
        uses: actions/setup-node@v3.2.0
        with:
          node-version: '16.x'
          cache: 'npm'
      - name: LCov merger tool
        run: npm install -g lcov-result-merger
      - name: Checkout code
        uses: actions/checkout@v3
      - uses: actions/cache@v1
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 6.0.x
      - name: Install MS SQL 2010 Express LocalDB
        uses: crazy-max/ghaction-chocolatey@v2
        with:
          args: install -r sqllocaldb --no-progress
      - name: Initialise LocalDB
        shell: bash
        run: |
          SqlLocalDB.exe create MSSQLLocalDB -s
          sqlcmd -l 180 -S (localdb)\MSSQLLocalDB -Q "SELECT @@VERSION;"
          sed -i'' -e 's/localhost/\(localdb\)\\MSSQLLocalDB/' Tests.Common/TestDatabases.txt
      - uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: '8.0'
          root-password: 'YourStrong!Passw0rd'
          auto-start: true
      - name: Build
        run: dotnet build --configuration Release --nologo --verbosity minimal
      - name: Initialise RDMP
        run: dotnet run -c Release --project Tools/rdmp/rdmp.csproj -- install (localdb)\MSSQLLocalDB TEST_
      - name: Test Reusable code
        shell: bash
        run: |
          rm -rf coverage
          echo dotnet test "Reusable/Tests/ReusableCodeTests/ReusableCodeTests.csproj" --nologo --collect:"XPlat Code Coverage" --no-build --verbosity minimal -c Release -r coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
          echo mv `find coverage -type f` recode.lcov
      - name: Test Core code
        shell: bash
        run: |
          echo dotnet test "./Rdmp.Core.Tests/Rdmp.Core.Tests.csproj" --nologo --collect:"XPlat Code Coverage" --no-build --verbosity minimal -c Release -r coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
          echo mv `find coverage -type f` core.lcov
      - name: Test UI code
        shell: bash
        run: |
          echo dotnet test "./Rdmp.UI.Tests/Rdmp.UI.Tests.csproj" --nologo --collect:"XPlat Code Coverage" --no-build --verbosity minimal -c Release -r coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
          echo mv `find coverage -type f` ui.lcov

      - name: Test with local file system
        shell: bash
        run:  |
              echo "UseFileSystemRepo: true" >> Tests.Common/TestDatabases.txt
              cat Tests.Common/TestDatabases.txt
      - name: Test Reusable (with file system repo)
        shell: bash
        run: |
          echo dotnet test "Reusable/Tests/ReusableCodeTests/ReusableCodeTests.csproj" --nologo --collect:"XPlat Code Coverage" --no-build --verbosity minimal -c Release -r coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
          echo mv `find coverage -type f` recodefs.lcov
      - name: Test Core (with file system repo)
        shell: bash
        run: |
          echo dotnet test "./Rdmp.Core.Tests/Rdmp.Core.Tests.csproj" --nologo --collect:"XPlat Code Coverage" --no-build --verbosity minimal -c Release -r coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
          echo mv `find coverage -type f` corefs.lcov
      - name: Test UI (with file system repo)
        shell: bash
        run: |
          echo dotnet test "./Rdmp.UI.Tests/Rdmp.UI.Tests.csproj" --nologo --collect:"XPlat Code Coverage" --no-build --verbosity minimal -c Release -r coverage -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
          echo mv `find coverage -type f` uifs.lcov
      
      - name: Merge LCovs
        run: echo lcov-result-merger "{ui,core,recode}{,fs}.lcov" all.lcov
      - name: Coveralls
        if: ${{ false }}
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.github_token }}
          path-to-lcov: all.lcov
          flag-name: unit tests
      
      - name: Package
        run: |
          dotnet publish Application/ResearchDataManagementPlatform/ResearchDataManagementPlatform.csproj -r win-x64 -c Release -o PublishWinForms --verbosity minimal --nologo
          dotnet publish Tools/rdmp/rdmp.csproj -r win-x64 -c Release -o PublishWindows --verbosity minimal --nologo
          dotnet publish Tools/rdmp/rdmp.csproj -r linux-x64 -c Release -o PublishLinux --verbosity minimal --nologo
      - name: BundleSource
        shell: cmd
        run: powershell -noexit -executionpolicy bypass "& ./BundleSourceIntoZipFile.ps1"
      - name: Get the version
        id: get_version
        # Get the tag name e.g. v5.0.0 but skip the 'v'
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\/v/}
        shell: bash

      - name: Sign
        shell: bash
        run: |
          signtool=(/c/Program\ Files\ \(x86\)/Windows\ Kits/10/bin/*/x64/signtool.exe)
          signtool=${signtool[${#signtool[@]}-1]}
          signtool=`echo $foo | tr / \\ | sed -e 's/^\\c/c:/'`
          echo ${{ secrets.DIGICERT_PFX }} | base64 --decode > GitHubActionsWorkflow.pfx
          echo cmd /c \"$signtool Sign  /f GitHubActionsWorkflow.pfx /fd sha256 /tr http://timestamp.digicert.com /td sha256 /p '${{ secrets.DIGICERT_PASSWORD }}' PublishWindows/*.dll PublishWindows/*.exe PublishLinux/*.dll PublishWinForms/*.exe PublishWinForms/*.dll\"
          cmd /c \"$signtool Sign  /f GitHubActionsWorkflow.pfx /fd sha256 /tr http://timestamp.digicert.com /td sha256 /p '${{ secrets.DIGICERT_PASSWORD }}' PublishWindows/*.dll PublishWindows/*.exe PublishLinux/*.dll PublishWinForms/*.exe PublishWinForms/*.dll\"
          echo packing
          mkdir -p dist
          (cd PublishWindows ; zip -9r ../dist/rdmp-cli-win-x64.zip .)
          (cd PublishLinux ; zip -9r ../dist/rdmp-cli-linux-x64.zip .)
          mv PublishLinux rdmp-cli-linux
          tar cf - rdmp-cli-linux | pixz -9e > dist/rdmp-cli-linux-x64.tar.xz
          (cd PublishWinForms ; zip -9r ../dist/rdmp-client.zip .)
          echo done

      - name: Nuget packages
        if: contains(github.ref, 'refs/tags/v')
        run: |
          nuget pack Plugins/Plugin/Plugin.nuspec -Properties Configuration=Release -IncludeReferencedProjects -Symbols -Version ${{ steps.get_version.outputs.VERSION }}
          nuget pack Plugins/Plugin.UI/Plugin.UI.nuspec -Properties Configuration=Release -IncludeReferencedProjects -Symbols -Version ${{ steps.get_version.outputs.VERSION }}
          nuget pack Plugins/Plugin.Test/Plugin.Test.nuspec -Properties Configuration=Release -IncludeReferencedProjects -Symbols -Version ${{ steps.get_version.outputs.VERSION }}
          nuget pack Application/ResearchDataManagementPlatform/RDMP.nuspec -Properties Configuration=Release -Version ${{ steps.get_version.outputs.VERSION }}

          nuget push HIC.RDMP.Plugin.${{ steps.get_version.outputs.VERSION }}.nupkg -skipDuplicate -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_KEY }}
          nuget push HIC.RDMP.Plugin.UI.${{ steps.get_version.outputs.VERSION }}.nupkg -skipDuplicate -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_KEY }}
          nuget push HIC.RDMP.Plugin.Test.${{ steps.get_version.outputs.VERSION }}.nupkg -skipDuplicate -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_KEY }}
          
      - name: Archive production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: |
            dist
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@2.2.1
        if: contains(github.ref, 'refs/tags/v')
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: dist/*.zip
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
